Prosper Loan Data Analysis by Meichen Zhou
========================================================

## Abstract 
This report explores a Prosper loan dataset that contains peer-to-peer loan 
listing details of consumers with Prosper. We start with exploratory analysis on 
variables of interest, and then raise some deeper questions on the underlying 
relationship between variables. Finally, we build a predictive linear model for 
borrower's interest rate and justify the output.

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# install.packages('fiftystater')
# install.packages('openintro')
# install.packages('viridisLite')
# install.packages('tidyverse')
# install.packages('geofacet')
# install.packages('corrplot')
library(dplyr)
library(ggplot2)
library(GGally)
library(fiftystater)
library(openintro)
library(viridis)
library(tidyverse)
library(memisc)
library(corrplot)
```

## Introduction of Data 
The prosper data set consists of 113,937 observations and 81 variables. The data
is on the level of ListingNumber of each loan. The first step of analysis is to 
import the data from csv file to R dataframe. Then we get a better understanding 
of the data by looking at the variable list, variable types, the print-out and 
the distribution of variables, and the unique count and missing count of 
selective variables such as borrower rate, term, prosper score, loan amount, 
credit history etc. 

```{r echo=FALSE,  message=FALSE, warning=FALSE, Load_Loan_Data}
loan <- read.csv('C:/Users/mezhou/programming/R/FinalProject/prosperLoanData.csv')
loan.initial <- subset(loan, 
                    select = c('ListingNumber', 'Term', 'BorrowerRate', 
                              'EstimatedReturn', 'ProsperScore', 'EmploymentStatus', 
                              'IsBorrowerHomeowner', 'CurrentCreditLines', 
                              'TotalInquiries', 'CurrentDelinquencies', 
                              'AmountDelinquent', 'BankcardUtilization', 
                              'DebtToIncomeRatio', 'StatedMonthlyIncome', 
                              'LoanOriginalAmount', 'LoanOriginationQuarter', 
                              'Investors', 'CreditScoreRangeLower', 
                              'CreditScoreRangeUpper'))

# Basic summaries of loan data
str(loan)
head(loan.initial)
summary(loan.initial)

# Check unique counts and missing values
sapply(loan.initial, function(x) length(unique(x)))
sapply(loan.initial, function(x) sum(is.na(x)))
```


## Univariate Plots Section


```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots1}
# There is no other data point outside 12, 36 and 60 terms. Hence, it is better to factorize the terms, so they appear categorical.
table(loan$Term)
loan$TermFactor <- factor(loan$Term, levels=c(12,36,60), ordered=TRUE)
ggplot(aes(x = TermFactor), data = loan) + geom_bar()
```

Most Prosper loans have a term of 36 months, followed by 60 months. Very few 
loans have a 12-month term.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots2}
qplot(data = loan, x = LoanStatus) +
     theme(axis.text.x = element_text(angle = 45, vjust = .5, color = "black"))
loan$LoanStatusGroup <- with(loan, ifelse(LoanStatus == 'Cancelled', 'Cancelled',
                                   ifelse(LoanStatus == 'Chargedoff', 'Chargedoff',
                                   ifelse(LoanStatus == 'Completed', 'Completed',
                                   ifelse(LoanStatus == 'Current', 'Current', 
                                        'Past Due')))))
table(loan$LoanStatusGroup)
qplot(data = loan, x = LoanStatusGroup)
```

The first graph shows the number of Prosper loans by category of loan status. As
there are multiple 'Past Due' columns that have low counts, we group them into 
one field as shown in the second graph. Naturally, most cases are current or 
completed. There are about 7,290 past-due loan cases, which constitutes about 
6.4% of all loans with Prosper.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots3}
summary(loan$AmountDelinquent)
qplot(data = subset(loan, !is.na(AmountDelinquent)), x = AmountDelinquent)

table(subset(loan %>% filter(AmountDelinquent == 0))$AmountDelinquent)
summary(subset(loan %>% filter(AmountDelinquent > 0))$AmountDelinquent)
summary(log10(subset(loan %>% filter(AmountDelinquent > 0))$AmountDelinquent))

qplot(data = subset(loan %>% filter(AmountDelinquent > 0)), x = AmountDelinquent) +
    scale_x_log10() 

```

Almost 80% of borrowers, also 89,818 out of 113,937 don't have delinquency. 
7,622 of the rest are unavailable. Taking the log of AmountDelinquent, the plot 
shows a normal distribution with log10 value of 3 being the peak, which is a few
thousand dollars on average.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots4}
summary(loan$CurrentCreditLines)
qplot(data = subset(loan, !is.na(CurrentCreditLines)), x = CurrentCreditLines, binwidth = 1) +
     scale_x_continuous(limits = c(0, 60), breaks = seq(0, 60, 5))
```

The distribution of current credit lines skewed right, peaking around 7 to 10. 



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots5}
summary(loan$LoanOriginalAmount)

qplot(data = subset(loan, !is.na(LoanOriginalAmount)), x = LoanOriginalAmount) +
     scale_x_continuous(breaks = seq(0, 35000, 2500))
```

The loan original amount is right skewed, having multiple peaks of $3,000, 
$10,000, and $15,000. Most loans are below the amount of $12,000.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots6}
# I found that max/100 is a good binwidth
summary(loan$BorrowerRate)
qplot(data = subset(loan, !is.na(BorrowerRate)), x = BorrowerRate, binwidth = .005) +
     xlim(0, 1) +
     scale_x_continuous(breaks = seq(0, 1, 0.2)) +
     scale_y_continuous(breaks = seq(0, 6000, 500))
```

The borrower rate, also the interest rate of consumers peaks at about 3.2% 
with more than 5,500 cases. The range goes from 5% to 36% for most consumers. 
And the average value of borrower rate is 19.3%.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots7}
# Prosper score is ordinal, thus need to use bar chart, not histogram 
# https://ggplot2.tidyverse.org/reference/geom_bar.html
table(loan$ProsperScore)
ggplot(data = subset(loan, !is.na(ProsperScore)), aes(x = ProsperScore)) +
     geom_bar() + scale_x_discrete(limits = c("1","2", "3", "4", "5", "6", "7", "8", "9", "10", "11"))
```

Prosper rate is a custom risk score built using historical Prosper data. 
The score ranges from 1-10, with 10 being the best, or lowest risk score'. 
There are some score outliers that are larger than the maximum score 10. 
Other than that, the Prosper score 'prefers' to take even values, 4, 6 and 8.  



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots8}
table(loan$ListingCategory..numeric.)
qplot(data = loan, x = ListingCategory..numeric.) +
     scale_x_continuous(breaks = seq(0, 20, 1)) +
     labs(x = "ListingCategory")
```

This is an interesting histogram that shows the purpose of a personal loan. Code
number 1 (Debt Consolidation) has almost 60K records surpassing all the other 
listing catogories. 



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots9}
ggplot(data = loan, aes(x = IncomeRange)) + geom_bar(aes(y = ..count..), stat = 'count') + 
      scale_x_discrete() + 
      theme(axis.text.x = element_text(angle = 45, vjust = .5, color = "black"))
```

The income range follows a normal distribution, with most borrowers having 
$25000~$49000 and $50000~$74999. Interestingly some borrowers have $0 income. 
Also there doesn't exist a 'higher than $100000' bucket, which is not uncommon
in high-tech regions such as California.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots10}
summary(loan$DebtToIncomeRatio)
qplot(data = subset(loan, !is.na(DebtToIncomeRatio)), x = DebtToIncomeRatio, 
     geom = 'freqpoly', binwidth = .01) +
     scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1))
```

As a requirement of Prosper loan application, the debt to income ratio should 
be less than 0.5 to qualify. Most of the loan cases in the dataset satisfies 
this rule with some outliers. In most cases, the debt to income ratio for 
consumers ranges from 0.1 to 0.3. This is a useful indicator for people who are 
interested in applying for a Prosper loan.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots11}
summary(loan$CreditScoreRangeLower)
summary(loan$CreditScoreRangeLower)

ggplot(data = subset(loan, !is.na(CreditScoreRangeLower)|!is.na(CreditScoreRangeUpper))) +
    geom_density(aes(CreditScoreRangeLower), fill = "red", alpha = 0.2) +
    geom_density(aes(CreditScoreRangeUpper), fill = "blue", alpha = 0.2) +
    scale_x_continuous(limits = c(450, 900), breaks = seq(350, 900, 50)) +
    xlab("Credit Score Range")

```

The plot dipicts the lower range and upper range of credit scores of borrowers. 
Lower is shown is red while upper in blue.

The distribution of credit scores of borrowers is close to normal distribution,
peaking around 680 to 700. 



```{r echo=FALSE,  message=FALSE, warning=FALSE, Univariate_Plots12}
ggplot(data = subset(loan, !is.na(LoanOriginationQuarter)), aes(x = LoanOriginationQuarter)) + 
      geom_bar(aes(y = ..count..), stat = 'count') + 
      theme(axis.text.x = element_text(angle = 45, vjust = .5, color = "black"))

loan$LoanOrigQuarter <- paste(substr(loan$LoanOriginationQuarter, 4, 7), substr(loan$LoanOriginationQuarter, 1, 2))
table(loan$LoanOrigQuarter)
ggplot(data = subset(loan, !is.na(LoanOrigQuarter)), aes(x = LoanOrigQuarter)) + 
      geom_bar(aes(y = ..count..), stat = 'count') +
      theme(axis.text.x = element_text(angle = 45, vjust = .5, color = "black"))
```

The first plot is not in chronological order. After a rearrange of year and 
quarter, we have the second time series graph that depicts ups and downs in 
number of loan listings the company has. Prosper was founded in year 2005, 
which explains the low count in the fourth quarter of 2005. The business 
gradually grew in the next few years, then had a very sharp decline in 2008 
because of the global financial crisis. The recovery took some time when the 
number of loans climbed up in 2009 and 2010. By the end of 2011, the company 
regained the history-high record. Overall, the growth was most impressive in 
year 2013 when the loan amount rocketed to almost 15,000 in the fourth quarter.




## Univariate Analysis

### What is the structure of your dataset?

There are 113,937 observations of 81 variables in the Prospect Loan dataset. In 
this analysis we are going to focus on fields - Term, BorrowerRate, ProsperScore, 
EmploymentStatus, IsBorrowerHomeowner, CurrentCreditLines, CurrentDelinquencies, 
AmountDelinquent, DebtToIncomeRatio,StatedMonthlyIncome,LoanOriginalAmount,
LoanOriginationQuarter, CreditScoreRangeLower and CreditScoreRangeUpper etc.

#### **A few definitions of the above fields are vital to our analysis**

**Term** The length of the loan expressed in months.

**BorrowerRate** The Borrower's interest rate for this loan.

**ProsperScore**	A custom risk score built using historical Prosper data. 
The score ranges from 1-10, with 10 being the best, or lowest risk score.  
Applicable for loans originated after July 2009. (Note that there are 29084 
missing values.)

**CreditScoreRangeLower/Upper** The lower/upper value representing the range of 
the borrower's credit score as provided by a consumer credit rating agency.

**AmountDelinquent** Dollars delinquent at the time the credit profile was pulled.

**DebtToIncomeRatio** The debt to income ratio of the borrower at the time the 
credit profile was pulled. This value is Null if the debt to income ratio is not 
available. This value is capped at 10.01 (any debt to income ratio larger than 
1000% will be returned as 1001%).

**CurrentCreditLines** Number of current credit lines at the time the credit 
profile was pulled.

**ListingCategory**	The category of the listing that the borrower selected when 
posting their listing: 0 - Not Available, 1 - Debt Consolidation, 2 - Home 
Improvement, 3 - Business, 4 - Personal Loan, 5 - Student Use, 6 - Auto, 
7- Other, 8 - Baby&Adoption, 9 - Boat, 10 - Cosmetic Procedure, 11 - Engagement
Ring, 12 - Green Loans, 13 - Household Expenses, 14 - Large Purchases, 
15 - Medical/Dental, 16 - Motorcycle, 17 - RV, 18 - Taxes, 19 - Vacation, 
20 - Wedding Loans

**LoanOriginalAmount** The origination amount of the loan.

#### **Some observations from the single variable exploration**

a) The term of loan are mostly 36 and 60 months, in other words 3 or 5 years.

b) Almost half of the records are current loans. 6.4% are past due.

c) The IQR of the borrower rate is 14% ~ 32%, with 32% being the most popular 
rate of all loans.

d) Prosper score follows a pseudo normal distribution in even and odd sets of 
scores respectively. It's interesting that there are overall more even scores 
than odd scores in the middle range 3~8.

e) The credit score median is normal distributed, peaking around 680 - 700.

f) Almost 80% of borrowers don't have any delinquency. 

g) The borrowers' credit Lines is right skewed, peaking around 7 to 10.

h) 75 Quantile of loan amount is $12,000. There are several peaks at $3,000, 
$10,000, and $15,000.

i) More than half of the listings are created for the purpuse of Debt 
Consolidation, followed by Home Improvement, Business and Auto.

j) Most borrowers have an income of $25000 to 75000 annually.

k) The number of loans at Prosper follows a chronological pattern.


### What is/are the main feature(s) of interest in your dataset?

The most important features in the dataset are BorrowerRate and ProsperScore.
For a consumer seeking for a peer-to-peer personal loan, the interest rate will 
be the key factor that one considers when shopping around. I am interested in 
finding the relationship between BorrowerRate and ProsperScore, which is solely 
based on Prosper history of the consumer who is applying. For that reason, there 
are other factors from the credit history perspective that also contributes 
to the BorrowerRate, such as CreditScoreRangeLower/Upper.

### What other features in the dataset do you think will help support your \
investigation into your feature(s) of interest?

The term, consumer's credit history, time of application and monthly income will
help support my investigation. 

### Did you create any new variables from existing variables in the dataset?

I regrouped LoanStatus 'Past Due' section into one, because each sub-category of
'Past Due' has too few records compared to other categories. The final histogram 
of 5 main categories is more meaningful to the audience.

Moreover, I rearranged the LoanOriginationQuarter variable so that the value of 
the new catogories are chronological, which provides convenience and clarity in 
the time series histogram. We could see how Prosper's loan business fluctuate 
over time.

### Of the features you investigated, were there any unusual distributions? \
Did you perform any operations on the data to tidy, adjust, or change the form \
of the data? If so, why did you do this?

The ProsperScore is supposed to range from 0 to 10, but I found some outliers 
valued at 11. These could be bador old data(earlier than July 2009), so I 
excluded them from the histogram by setting the limits on x axis. In this way, 
we have a clean vision of the distribution of ProsperScore.





## Bivariate Plots Section

At the beginning of this section, I create a right subset function that scans 
the string from the right side. Also I create two new variables. The first is 
the CreditScoreMedian calculated from CreditScoreRangeLower and Upper. The 
second is CreditHistory calculated from FirstRecordedCreditLine. CreditHistory 
is on the level of years.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Bivariate_GGpairs}
# Create substr function that starts from the right side of a string
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

# Create new variables
loan$CreditScoreMedian <- with(loan, (CreditScoreRangeLower + CreditScoreRangeUpper)/2)
loan$CreditHistory <- with(loan, 2018 - as.numeric(
     substr(substrRight(as.character(loan$FirstRecordedCreditLine), 9), 1, 4))
     )

vars <-   c(which(colnames(loan) == 'TermFactor'),
            which(colnames(loan) == 'BorrowerRate'),
            # which(colnames(loan) == 'EstimatedReturn'),
            which(colnames(loan) == 'ProsperScore'),
            which(colnames(loan) == 'EmploymentStatus'),
            # which(colnames(loan) == 'IsBorrowerHomeowner'),
            # which(colnames(loan) == 'CurrentCreditLines'),
            # which(colnames(loan) == 'CurrentDelinquencies'),
            which(colnames(loan) == 'AmountDelinquent'),
            which(colnames(loan) == 'DebtToIncomeRatio'),
            which(colnames(loan) == 'StatedMonthlyIncome'),
            # which(colnames(loan) == 'LP_InterestandFees'),
            # which(colnames(loan) == 'Investors'),
            which(colnames(loan) == 'CreditScoreMedian'),
            which(colnames(loan) == 'CreditHistory'))

# Only observe variable relationships of current loans, count is 56576
loan_subset <- loan[loan$LoanStatusGroup =='Current', vars]
#ggpairs(loan_subset, axisLabels = 'internal',
#      lower = list(continuous = wrap("points", shape = I('.'))),
#      upper = list(combo = wrap("box", outlier.shape = I('.')))) 

ggpairs(loan_subset,
       lower = list(continuous = wrap("points", shape = I('.'))),
       upper = list(combo = wrap("box", outlier.shape = I('.')))) + 
        theme(axis.ticks = element_blank(),
              axis.text = element_blank())
ggcorr(loan_subset, hjust = .85, size = 3, layout.exp = 2,
       label = TRUE, label_size = 3, label_color = "darkblue")
```

The above ggpairs graph only reflect the 56,576 current loans with Prosper. It 
still provides a full insight on the most up-to-date loan information that 
assists future analysis between two and multiple variables. As we can see, the 
ggcorr graph provides a clear illustration on variable correlation. Pairs in 
dark red and blue will be focused on in the follow-up analysis.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Bivariate_Plots1}
ggplot(aes(x = ProsperScore, y = BorrowerRate), data = subset(loan_subset, !is.na(ProsperScore))) + 
     geom_jitter(alpha = .01, shape = 21, fill = I('darkblue'))+
     scale_x_continuous(limits = c(0, 10), breaks = seq(0, 10, 1))
```

Prosper interest rate is lower when a borrower has higher ProsperScore, proving 
the strong linear correlation of -0.7.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Bivariate_Plots2}
ggplot(aes(x = StatedMonthlyIncome, y = BorrowerRate), data = subset(loan_subset, !is.na(ProsperScore))) + 
    geom_point(alpha = .01, shape = 21, fill = I('#00A8FF'))
summary(subset(loan_subset, !is.na(ProsperScore))$StatedMonthlyIncome)
qplot(y = StatedMonthlyIncome, data = subset(loan_subset, !is.na(ProsperScore)),
      geom = 'boxplot', ylim=c(0, 20000))
      
ggplot(aes(x = StatedMonthlyIncome, y = BorrowerRate), data = subset(loan_subset, !is.na(ProsperScore))) + 
    geom_point(alpha = .01, shape = 21, fill = I('#00A8FF')) +
    scale_x_continuous(limits = c(0, 20000))
```

The stated monthly income axis is tailored as the majority of monthly income are 
well below $20,000. From the second scatterplot, there doesn't exist a strong 
correlation between income and borrower rate.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Bivariate_Plots3}
summary(loan_subset$BorrowerRate)
ggplot(aes(x = CreditScoreMedian, y = BorrowerRate), data = loan_subset) +
    geom_point(alpha = .1, size = .1, position = 'jitter', color = 'violet')  +
    scale_x_continuous(limits = c(500, 900), breaks = seq(500, 900, 100))
```

The credit score axis is adjusted to normal credit range by common sense. It 
looks from the graph that CreditScore and BorrowerRate are negatively correlated
at level of -0.5 by the Pearson correlation test.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Bivariate_Plots4}
ggplot(aes(x = EmploymentStatus, y = ProsperScore),
      data = subset(loan, !is.na(ProsperScore))) + 
      geom_boxplot() + stat_summary(fun.y = mean, geom = 'point', shape = 4)
```

The boxplot shows the relationship between prosper score and employment status. 
Full-time consumers have the highest IQR and mean of prosper score, while 
Self-employed category have the lowest. As we can observe, the distribution of 
full-time category is skewed, since people may have all kinds of occupations 
whose income and credit habits vary a lot. It is surprising that people who are 
'Retired' have higher prosper score than Employed and Self-employed categories. 
I wonder what the differenc is between category Employed and Full-time.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Bivariate_Plots5}
ggplot(aes(x = EmploymentStatus, y = CurrentCreditLines),
      data = subset(loan, !is.na(CurrentCreditLines))) + 
      geom_boxplot() + stat_summary(fun.y = mean, geom = 'point', shape = 3)

ggplot(aes(x = EmploymentStatus, y = CurrentCreditLines),
      data = subset(loan, !is.na(CurrentCreditLines)&(CurrentCreditLines <= 25))) + 
      geom_boxplot() + stat_summary(fun.y = mean, geom = 'point', shape = 3) +
      scale_y_continuous(limits = c(0, 25), breaks = seq(0, 25, 5)) 
```

How active is each type of employment in credit cards and loans activities? The
first boxplot tells us that the part-time group is the least active in having 
loans and openning credit cards. The Employed group have the most outliers, 
followed by Full-time and Self-employed. It is understandable that financial 
institutions are more willing to open credit lines for small business or 
consumers who have a stable income.

Zooming in to credit lines of 0~25, it's clear that Employed consumers have the
highest credit lines open of about 11, while Not-employed and Part-time have the 
lowest average of about 7.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Bivariate_Plots6}
summary(loan$AmountDelinquent) # Most people 0 
ggplot(aes(IsBorrowerHomeowner, AmountDelinquent), data = subset(loan, !is.na(AmountDelinquent))) + 
      geom_jitter(alpha = .05, shape = 21, fill = I('#099DD9')) +
      scale_y_continuous(limits = c(0, 1e+05))
```

This jitter plot graph shows that consumers who have are homeowners have a 
longer tailed delinquent distribution, thus slightly higher delinquency amount 
if exists than those who are mortgage care-free.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Bivariate_Plots7}
summary(loan$DebtToIncomeRatio)
ggplot(aes(x = CreditHistory, y = DebtToIncomeRatio), data = subset(loan, !is.na(DebtToIncomeRatio))) + 
      geom_point(alpha = .25, position = position_jitter()) 

ggplot(aes(x = CreditHistory, y = DebtToIncomeRatio, fill = I('#099DD9')), 
      data = subset(loan, !is.na(DebtToIncomeRatio)&(DebtToIncomeRatio < 1))) + 
      geom_point(alpha = .01, position = position_jitter()) +
      geom_hline(yintercept = .5, alpha = .8, linetype = 2) +
      scale_x_continuous(limits = c(0, 66), breaks = seq(0, 70, 5))
```

Prosper requires a consumer to have debt to income ratio of less than 50% to 
qualify for the loan application. From the first graph there are lots of 
outliers above 50%, even up to 1001% where the value is capped. Zooming in, we 
can see there is a full range of debt to income ratio from 0 to 60% and 70% for 
consumers with a credit history of 10 to 40 years. The peak is at 20~25 years of 
credit history. Let's say a consumer has the first credit card at age 20. Adding 
20 years makes him 40 plus, which is about the age most people have a home and 
kids to supply. It makes sense these consumers have more debts at the peak of 
their financial burden and responsibilities. 

Next we want to build a simple linear regression model to predict the borrower 
rate, using prosper score as the only predictor.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Bivariate_Model}
loan.lm1 <- subset(loan, select = c('BorrowerRate', 'ProsperScore'))

m1 <- lm(I(BorrowerRate) ~ I(ProsperScore), data = subset(loan.lm1, !is.na(ProsperScore)))
mtable(m1, sdigits = 3)

with(subset(loan.lm1, !is.na(ProsperScore)), cor.test(BorrowerRate, ProsperScore, method = 'pearson'))
```

We can observe a negative relationship between the borrower rate and prosper 
score. The Pearson correlation test also indicates a negative linear 
relationship between the two variables(correlation = -0.65).

As for the linear model, the explanatory variable ProsperScore has a p value 
much less thatn 0.05, and it accounts for 42.2% of the variance in BorrowerRate. 
The parameter of prosper score is -0.02, meaning that as prosper score increases 
by one unit, the borrower rate decreases by 0.02, which is 2%. 

In the next section we are going to include more credit-related and loan-related
variables that could explain BorrowerRate.




## Bivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. How did the feature(s) of interest vary with other features in \
the dataset?

First, prosper score has a negative positive relationship with interest rate.
The higher the prosper score, the lower(the better) the interest rate.

Second, there doesn't exist a noticable linear correlation between stated 
monthly income and borrower rate. As we see the pearson correlation coefficient 
is as low as 0.1.

Additionally, full-time and employed consumers have the highest average prosper
score and also the highest average number of open credit lines. Self-employed 
consumers have high number of credit lines, most likely for business reasons. 

### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

A borrower who already has mortgage tend to have more amount delinquency as the
pressure of mortgage and household must be high.

Borrowers having 20~30 years of credit history have the highest debt to income 
ratio, with some outliers rocketing up to more than 1000%. The ratio becomes
much lower for people who have 40 years of credit history, making them about 60 
years old.

### What was the strongest relationship you found?

The debt to income ratio of consumers is very concentrated around the area of 
credit history ranging 10 to 35. A negative relationship can be observved from 
the plotting as well. As a requirement to apply for personal loans at Prosper, 
a borrower need to have minimum two years of credit history, and the reported 
average value is 11, which are both verified from the graph. As these two 
variables are vital criteria in loan application, we are going to investigate 
them more in the next modeling section.





## Multivariate Plots Section

```{r echo=FALSE,  message=FALSE, warning=FALSE, Multivariate_Prepare}
loan.state <- loan %>% 
              # na.omit() %>%
              group_by(BorrowerState) %>%
              summarise(loan_count = n(), 
                        loan_mean = mean(LoanOriginalAmount)) %>%
              arrange(desc(loan_count))
loan.state$BorrowerStateFull <- tolower(abbr2state(loan.state$BorrowerState))
head(loan.state, 10)
```

Grouped the loan data from listing level to state level, calculating the number 
of loan for each state as loan_count and average loan amount as loan_mean from 
LoanOriginalAmount.

The printed data frame is ordered by decending loan_count. The top 5 states 
having the highest number of loan counts are California, Texas, New York, 
Florida and Illinois.

Below is a geographical heatmap of the number of Prosper loans in the United 
States in Prosper history, which presents the same information as the above data.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Multivariate_Plots1}

ggplot(loan.state, aes(map_id = BorrowerStateFull)) + 
     geom_map(aes(fill = loan_count), map = fifty_states) + 
     expand_limits(x = fifty_states$long, y = fifty_states$lat) +
     coord_map() +
     ggtitle('Heatmap of loan count')

ggplot(loan.state, aes(map_id = BorrowerStateFull)) + 
     geom_map(aes(fill = loan_mean), map = fifty_states) + 
     expand_limits(x = fifty_states$long, y = fifty_states$lat) +
     coord_map() +
     ggtitle('Heatmap of loan average')

loan.state2 <- loan.state %>% arrange(desc(loan_mean))
head(loan.state2)
```
Additionally, the second heat map dipicts the average loan_mean for each state. 
It's shown that although the states on the east coast have low loan counts, 
their loan amount is very high. This interesting combination is probably due to 
the distance from the Prosper hub on the west coast but also the fast-growing 
economy on the east coast.



Next is BorrowerRate over loan origination year in an effort to check if there
is an trend in the interest rate of borrowers over time. 

We only observe the top 6 states with the highest loan_count here. Variable 
LoanOrigYear is created from LoanOriginationQuarter by only capturing the year 
the loan was created.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Multivariate_Plots3}
sample.states <- c('CA', 'FL', 'IL', 'GA', 'TX', 'NY')
loan$LoanOrigYear <- as.numeric(substr(loan$LoanOriginationQuarter, 4, 7))

ggplot(aes(x = LoanOrigYear, y = BorrowerRate, group = 1), data = subset(loan, BorrowerState %in% sample.states)) +
      facet_wrap( ~BorrowerState) +
      geom_boxplot() +
      stat_summary(fun.y = mean, geom = 'point', shape = 4) +
      scale_x_continuous(breaks = seq(2006, 2014, 1)) +
      theme(axis.text.x = element_text(angle = 45, vjust = .5, color = "grey")) +
      ggtitle('Trend in interest rates in top 6 states')
```

This faceted boxplot provides an amazing illustration on how the BorrowerRate 
fluctuates over time, in other words, in the general economy background.

The financial crisis really hit the economy and the personal loan market in 
2008 and 2009, forcing vendors like Prosper lower their interest rate to attract 
borrowers. From the perspective of the states, Texas and New York didn't do very 
well in particular during the crisis. In comparison, California, Gorgia and 
Illinois suffered less hit. 

The loan business came back to live in 2011 and 2012 as the economy started to
revitalize. We can observe a very good performance for New York and Texas.



```{r echo=FALSE,  message=FALSE, warning=FALSE, Multivariate_Plots4}
# Ordinal variables must be encoded by ordinal color themes. Factorized the Term in the Univariate section - plot1.
ggplot(aes(x = LoanOrigYear, y = BorrowerRate), data = loan) + 
      geom_point(aes(color = TermFactor), alpha = .25, size = .06, position = 'jitter') + 
      guides(color = guide_legend(title = 'Term', override.aes = list(alpha = 1, size = 2))) +
      theme(axis.text.x = element_text(angle = 45, vjust = .5, color = "grey")) +
      ggtitle('Trend in interest rates for different loan terms')
```

Similarly, the jitter point graph also indicates much less business in 2008 
and fast growth in 2011 and 2012 as the density of colors change. In particular, 
we see long term loans as shown in light blue starting to boom in 2011. This 
also relates back to the previous boxplot that in 2011 and 2012 the average of 
BorrowerRate was high.




#### **Multivariate linear model - Iteration one**

Use Prosper history information as well as loan-related information as 
predictors for BorrowerRate.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Multivariate_Models1}
m1 <- lm(I(BorrowerRate) ~ I(ProsperScore) + I(CreditScoreMedian), data = loan)
m2 <- update(m1, ~ . + Term)
m3 <- update(m2, ~ . + LoanOrigYear)
m4 <- update(m3, ~ . + LoanOriginalAmount)
m5 <- update(m4, ~ . + StatedMonthlyIncome)
mtable(m1, m2, m3, m4, m5, sdigits = 4)
```

The six vairables accounts for 67.18% of the variation of the BorrowerRate. 
The p value is less than 0.05 for each predictor, so we are confident to reject 
the null hypothesis that coefficients are 0. Therefore, the coefficients are 
valid in the above chart. In other words, the 6 variables are all meaningful 
in prediction of the borrower interest rate at Prosper.



#### **Multivariate linear model - Iteration two**

A few adjustments are made to the second iteration of the model.

a) Use log transformation on large values CreditScoreMedian, LoanOriginalAmount, 
StatedMonthlyIncome. Adjust if the value before log is less than 1.

b) Use year as unit for Term instead of month.

c) Change LoanOrigYear from numeric to character because the quantity doesn't 
contribute to the ProsperScore by common sense.

d) Add three credit-related predictors of interest - CreditHistory, 
DebtToIncomeRatio, IsBorrowerHomeowner.

```{r echo=FALSE,  message=FALSE, warning=FALSE, Multivariate_Models2}
m1 <- lm(I(BorrowerRate) ~ I(ProsperScore) + I(log(CreditScoreMedian)), data = loan)
m2 <- update(m1, ~ . + I(Term/12))
m3 <- update(m2, ~ . + as.factor(LoanOrigYear))
m4 <- update(m3, ~ . + log(LoanOriginalAmount))
m5 <- update(m4, ~ . + log(StatedMonthlyIncome + 1))
m6 <- update(m5, ~ . + DebtToIncomeRatio)
m7 <- update(m6, ~ . + CreditHistory)
m8 <- update(m7, ~ . + IsBorrowerHomeowner)
mtable(m1, m2, m3, m4, m5, m6, m7, m8, sdigits = 4)
```

Similar to the first iteration,the p value is less than 0.05 for each predictor, 
indicating that we are confident to reject the null hypothesis that coefficients 
are zero. This means that all credit-related additions are meaningful to the
model. Moreover, there is an overall improvement in R squared from 67.18% to
71.12%. If we look closer, there is actually an improvement on each level of 
predictor addition, meaning that the variable transformation and addition are 
worthwhile.




## Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. Were there features that strengthened each other in terms of \
looking at your feature(s) of interest?

As we can see from the jitter point graph 'Trend in interest rates for different
loan terms', the same conclusion can be drawn as the one variable qplot in the 
univariate plot section.

On top of that, time series observation is made when we look at the BorrowerRate
over time.

Also, in terms of Loan OriginationQuarter, the set of faceted boxplots 'Trend in
interest rates in top 6 states' has convinced the economy influence on Prosper's 
loan business, as is initially observed in the univariate section as well.  

### Were there any interesting or surprising interactions between features?

There are two interesting observations.

On the one hand, it's very helpful to observe the loan count as well as the 
loan average in the geographical graph of the United States. We know that most 
loans are from California where Prosper is hubbed, while the highest average 
loan is DC, an east-coast area. I wonder what reasons are behind that drive 
people to seek for large amounts of personal loans. From my perspective, 
California is also a high-salary state with many tech companies. Merely thinking 
from the economy perspective is not enough to answer this question intuitively.

On the other hand, the fluctuation of BorrowerRate over time follows similar 
trend as the number of loans over time. This is not surprising but very 
interesting to think about. More research could be initiated to look more into 
each State and different types of loans to see what levels of BorrowRate there 
are.

### OPTIONAL: Did you create any models with your dataset? Discuss the \
strengths and limitations of your model.

I created a multivariate model and made a modification on it.More credit-related
variables are included to increase the R squared, so that up to 71.12% variation 
of BorrowerRate is explained. This model is strong enough,having Prosper history,
loan features and credit history, although more predictors should be added to 
strengthen the model even more. Some other variables that could explain the 
BorrowerRate potentially are TotalInquiries, OpenRevolvingAccounts and 
PublicRecordsLast12Months.





## Final Plots and Summary

### Plot One

```{r echo=FALSE,  message=FALSE, warning=FALSE, Plot_One}
qplot(data = subset(loan, !is.na(BorrowerRate)), x = BorrowerRate, 
      binwidth = .005, color = I('black'), fill = I('lightblue3'), ylab = 'Frequency') +
      scale_x_continuous(limits = c(0, 0.4), breaks = seq(0, 0.4, 0.04)) +
      scale_y_continuous(breaks = seq(0, 6000, 500)) +
      ggtitle('Distribution of Borrower Interest Rate with Prosper')
```

### Description One
This is a univariate distribution of BorrowerRate. Refined the theme and axis 
ranges.The highest frequency of interest rate of a consumer's loan with Prosper 
is 32%, followed by range 14%~20%.



### Plot Two

```{r echo=FALSE,  message=FALSE, warning=FALSE, Plot_Two}
ggplot(aes(x = CreditScoreMedian, y = BorrowerRate), data = loan_subset) +
      geom_point(aes(color = TermFactor), alpha = .3, size = .1, position = 'jitter') +
      stat_smooth() +
      scale_color_brewer(type = 'qual', palette=1,
                        guide = guide_legend(title = 'Term', reverse = T, override.aes = list(alpha = 1, size = 2))) +
      scale_x_continuous(limits = c(500, 900), breaks = seq(350, 900, 50)) +
      scale_y_continuous(limits = c(0, 0.4), breaks = seq(0, 0.4, 0.1)) + 
      ggtitle('Borrower Interest Rate by Credit Score and Loan Term')

```

### Description Two
This is an upgrade on the negative relationship between interest rate and credit 
score, also adding a fitted line and layer of loan term. The fitted curve is 
close to linear, predictable in credit score range 550~850. The darker layer of 
dots are above the lighter layer, indicating that longer loan term usually means
higher interest rate. 



### Plot Three

```{r echo=FALSE,  message=FALSE, warning=FALSE, Plot_Three}
ggplot(loan.state, aes(map_id = BorrowerStateFull)) + 
     geom_map(aes(fill = loan_count), map = fifty_states) + 
     expand_limits(x = fifty_states$long, y = fifty_states$lat) +
     coord_map() +
     scale_x_continuous(breaks = NULL) + 
     scale_y_continuous(breaks = NULL) +
     scale_fill_continuous(low = 'lightgoldenrod2', high = 'purple3', guide = 'colourbar') + 
     labs(x = "", y = "") +
     theme(legend.position = "bottom", panel.background = element_blank()) +
     ggtitle('Number of Loans by State', subtitle = 'California has the highest number of loans') +
     fifty_states_inset_boxes()
```

### Description Three
This is a geographical heatmap of the average Prosper loan amount in the United 
States. California has the highest loan count overall, followed by Texas, and
Florida etc. There are very few loan listings originated from states in the 
middlewest.





## Reflection
The Prosper loan dataset is a large and resourceful one that contains 114K 
observations and more than 80 variables. Some variables have missing values or 
outliers that complicate the analysis here and there. I made a lot of efforts 
digging into the distribution and definition of each variable to find meaningful 
trend, features and relationship among data.

Luckily, I was able to apply all of the techniques I learned from the course to 
this project. I also researched online for more interesting graphic methods, 
such as the geographical heatmap. Some plots gave me a surprise, such as the 
Prosper collected interest and fees, while some others are insightful and 
meaningful, such as the loan amount and interest rate over time.

Additionally, I was able to build a predictive model on the borrower interest 
rate by using 9 predictors in three categories - prosper history, loan features
and historical credit performance. This model has a high explanation and 
predictive value for any consumers who are interested in having a personal loan 
with Prosper.

Nevertheless, more work could be done using this dataset. I could look more into
details on the cohorts of a time period, a few states, or one listing category. 
As for modeling, I could include more variables to increase the explanatory 
value of the multi-linear model, or I could fit other types of models that may 
have a higher predictive value.


## Reference 
https://www.nerdwallet.com/blog/loans/prosper-personal-loans-review/

https://stackoverflow.com/questions/7963898/extracting-the-last-n-characters-from-a-string-in-r

https://prosper.zendesk.com/hc/en-us/articles/210013663-What-are-loan-interest-rates-and-estimated-investor-returns-

https://stackoverflow.com/questions/26665319/removing-na-in-dplyr-pipe

https://cran.r-project.org/web/packages/fiftystater/vignettes/fiftystater.html

https://stackoverflow.com/questions/45107302/error-in-seq-lennrowdata-1-argument-must-be-coercible-to-non-negative-in

https://cran.r-project.org/web/packages/openintro/openintro.pdf

http://sape.inf.usi.ch/quick-reference/ggplot2/colour

https://stackoverflow.com/questions/28427572/manipulating-axis-titles-in-ggpairs-ggally

https://briatte.github.io/ggcorr/

https://stackoverflow.com/questions/40406837/wrap-axis-labels-in-correlation-matrix

https://stackoverflow.com/questions/25833749/how-to-plot-two-density-curves-of-two-continuous-variables-on-the-same-chart



